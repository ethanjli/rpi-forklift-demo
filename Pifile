# Note: the env vars used in the FROM directive and TO directives are not substituted by Pimod, so
# they must instead be substituted by GitHub Actions:
FROM @@BASE_IMAGE@@
TO @@OUTPUT_IMAGE_NAME@@.img

PUMP 8G

INSTALL os-setup /tmp/os-setup
RUN /bin/bash -c '\
  apt-get install -y systemd-container && \
  mkdir /sysroot && \
  mount --bind / /sysroot
  systemd-nspawn -D /sysroot --boot && \
  umount / \
'
RUN su - pi -s /bin/bash -c '\
  export DEBIAN_FRONTEND=noninteractive && \
  /tmp/os-setup/setup.sh && \
  /tmp/os-setup/cleanup.sh \
'

# Change default settings for the SD card to enable headless & keyboardless first boot
# Note: we could change the username by making a `/boot/userconf.txt` file with the new username
# and an encrypted representation of the password (and un-disabling and unmasking
# `userconfig.service`), but we don't need to do that for now.
# See https://github.com/RPi-Distro/userconf-pi/blob/bookworm/userconf-service and
# https://www.raspberrypi.com/documentation/computers/configuration.html#configuring-a-user and
# and the "firstrun"-related and "cloudinit"-related lines of
# https://github.com/raspberrypi/rpi-imager/blob/qml/src/OptionsPopup.qml and
# the RPi SD card image's `/usr/lib/raspberrypi-sys-mods/firstboot` and
# `/usr/lib/raspberrypi-sys-mods/imager_custom` scripts
RUN /bin/bash -c '\
  echo "pi:copepode" | chpasswd && \
  sed -i -e "s~^XKBLAYOUT=.*~XKBLAYOUT=\"us\"~" /etc/default/keyboard && \
  systemctl disable userconfig.service \
'
# This may be needed because we disabled userconfig.service. See
# https://forums.raspberrypi.com/viewtopic.php?p=2032694#p2032694
RUN /bin/bash -c 'systemctl enable getty@tty1'
